name: Deploy API Service

on:
  push:
    branches: [ main ]
    paths:
      - 'api_server.py'
      - 'database_manager.py'
      - 'requirements.txt'
      - 'hotspot_data.db'
  workflow_dispatch:
  # åœ¨å®šæ—¶çˆ¬è™«ä»»åŠ¡å®Œæˆåè§¦å‘APIéƒ¨ç½²
  workflow_run:
    workflows: ["Scheduled Data Crawling"]
    types: [completed]
    branches: [main]

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: pip install -r requirements.txt
      
    - name: Start API Server
      run: |
        # å¯åŠ¨APIæœåŠ¡
        echo "ğŸš€ å¯åŠ¨çƒ­ç‚¹æ•°æ®APIæœåŠ¡..."
        nohup python api_server.py > api_server.log 2>&1 &
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 5
        
        # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
        if curl -f http://localhost:5000/api/statistics > /dev/null 2>&1; then
          echo "âœ… APIæœåŠ¡å¯åŠ¨æˆåŠŸ"
          echo "APIæœåŠ¡è¿è¡Œåœ¨: http://localhost:5000"
        else
          echo "âŒ APIæœåŠ¡å¯åŠ¨å¤±è´¥"
          cat api_server.log
          exit 1
        fi
        
    - name: Keep alive (for testing)
      if: always()
      run: |
        # åœ¨æµ‹è¯•æœŸé—´ä¿æŒæœåŠ¡è¿è¡Œ
        echo "APIæœåŠ¡å°†æŒç»­è¿è¡Œç”¨äºæµ‹è¯•"
        echo "æŸ¥çœ‹æ—¥å¿—: cat api_server.log"
        echo "æµ‹è¯•API: curl http://localhost:5000/api/statistics"
        
        # åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥éƒ¨ç½²åˆ°äº‘å¹³å°
        echo "ç”Ÿäº§ç¯å¢ƒå»ºè®®éƒ¨ç½²åˆ°:"
        echo "- Heroku"
        echo "- Railway"
        echo "- DigitalOcean App Platform"
        echo "- AWS Elastic Beanstalk"