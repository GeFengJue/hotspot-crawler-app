name: Scheduled Data Crawling

on:
  schedule:
    - cron: '*/15 * * * *'  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºæäº¤
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: pip install -r requirements.txt
      
    - name: Run crawler and get statistics
      id: run-crawler
      run: |
        # è¿è¡Œçˆ¬è™«å¹¶æ•è·è¾“å‡º
        python_output=$(python hotspot_crawler.py 2>&1)
        echo "$python_output"
        
        # æå–æ•°æ®ç»Ÿè®¡ä¿¡æ¯
        total_count=$(echo "$python_output" | grep "æ€»å…±è·å–åˆ°" | awk '{print $3}')
        echo "total_count=$total_count" >> $GITHUB_OUTPUT
        
        # ä¿å­˜çˆ¬è™«è¾“å‡ºåˆ°æ–‡ä»¶ç”¨äºåç»­æ­¥éª¤
        echo "$python_output" > crawler_output.txt
        
    - name: Update hotspot data file
      run: python update_hotspot_data.py
      
    - name: Check for data changes
      id: check-changes
      run: |
        # æ£€æŸ¥JSONæ–‡ä»¶çš„å˜åŒ–
        json_changed=false
        
        if ! git diff --quiet hotspot_data.json; then
          json_changed=true
        fi
        
        if [ "$json_changed" = true ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "json_changed=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate update summary
      run: |
        # ç”Ÿæˆæ›´æ–°æ‘˜è¦
        if [ -f crawler_output.txt ]; then
          echo "ğŸ“Š æœ¬æ¬¡æ•°æ®æ›´æ–°ç»Ÿè®¡ï¼š" > update_summary.md
          echo "==========================" >> update_summary.md
          echo "" >> update_summary.md
          
          # æå–å„ç±»å‹æ•°æ®æ•°é‡
          echo "ğŸ“ˆ æ•°æ®åˆ†ç±»ç»Ÿè®¡ï¼š" >> update_summary.md
          grep "è·å–åˆ°" crawler_output.txt | while read line; do
            echo "- $line" >> update_summary.md
          done
          
          # æ€»æ•°æ®é‡
          if [ -n "${{ steps.run-crawler.outputs.total_count }}" ]; then
            echo "" >> update_summary.md
            echo "âœ… æ€»å…±è·å–åˆ° ${{ steps.run-crawler.outputs.total_count }} æ¡çƒ­ç‚¹æ•°æ®" >> update_summary.md
          fi
          
          # æ›´æ–°æ—¶é—´
          echo "" >> update_summary.md
          echo "ğŸ• æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> update_summary.md
          
          echo "æ›´æ–°æ‘˜è¦å·²ç”Ÿæˆ"
        fi
        
    - name: Commit and push data updates
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ·»åŠ å˜åŒ–çš„æ–‡ä»¶
        if [ "${{ steps.check-changes.outputs.json_changed }}" = "true" ]; then
          git add hotspot_data.json
        fi
        
        # æ·»åŠ æ›´æ–°æ‘˜è¦æ–‡ä»¶
        if [ -f update_summary.md ]; then
          git add update_summary.md
        fi
        
        # ç”Ÿæˆæäº¤ä¿¡æ¯
        commit_message="Auto-update data files $(date +'%Y-%m-%d %H:%M:%S')"
        if [ -n "${{ steps.run-crawler.outputs.total_count }}" ]; then
          commit_message="ğŸ“Š æ•°æ®æ›´æ–°: ${{ steps.run-crawler.outputs.total_count }}æ¡çƒ­ç‚¹æ•°æ® $(date +'%H:%M:%S')"
        fi
        
        git commit -m "$commit_message"
        git push
        
    - name: No changes notification
      if: steps.check-changes.outputs.changes == 'false'
      run: echo "No database changes detected"