name: Scheduled Data Crawling

on:
  schedule:
    - cron: '*/15 * * * *'  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ·»åŠ å†™å…¥æƒé™
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºæäº¤
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: pip install -r requirements.txt
      
    - name: Run crawler and get statistics
      id: run-crawler
      run: |
        # è¿è¡Œçˆ¬è™«å¹¶æ•è·è¾“å‡º
        python_output=$(python hotspot_crawler.py 2>&1)
        echo "$python_output"
        
        # æå–æ•°æ®ç»Ÿè®¡ä¿¡æ¯
        total_count=$(echo "$python_output" | grep "æ€»å…±è·å–åˆ°" | awk '{print $3}')
        echo "total_count=$total_count" >> $GITHUB_OUTPUT
        
        # ä¿å­˜çˆ¬è™«è¾“å‡ºåˆ°æ–‡ä»¶ç”¨äºåç»­æ­¥éª¤
        echo "$python_output" > crawler_output.txt
        
    - name: Update hotspot data file
      run: python update_hotspot_data.py
      
    - name: Check for data changes
      id: check-changes
      run: |
        # æ£€æŸ¥JSONæ–‡ä»¶çš„å˜åŒ–
        json_changed=false
        
        if ! git diff --quiet hotspot_data.json; then
          json_changed=true
        fi
        
        if [ "$json_changed" = true ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "json_changed=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Import data to database
      if: steps.check-changes.outputs.changes == 'true'
      run: python database_manager.py
      
    - name: Trigger API deployment
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        # æ•°æ®å·²æ›´æ–°ï¼ŒAPIæœåŠ¡éœ€è¦é‡æ–°éƒ¨ç½²ä»¥æä¾›æœ€æ–°æ•°æ®
        echo "âœ… æ•°æ®åº“å·²æ›´æ–°ï¼ŒåŒ…å«æœ€æ–°çƒ­ç‚¹æ•°æ®"
        echo "APIæœåŠ¡å°†åœ¨ä¸‹æ¬¡è¯·æ±‚æ—¶è‡ªåŠ¨æä¾›æœ€æ–°æ•°æ®"
        
        # å¦‚æœæœ‰APIæœåŠ¡è¿è¡Œï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‡å¯é€»è¾‘
        # åœ¨å®é™…éƒ¨ç½²ä¸­ï¼ŒAPIæœåŠ¡åº”è¯¥é…ç½®ä¸ºè‡ªåŠ¨é‡æ–°åŠ è½½æ•°æ®
        echo "å¦‚æœä½¿ç”¨ç‹¬ç«‹çš„APIæœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿é‡å¯æœåŠ¡ä»¥åŠ è½½æœ€æ–°æ•°æ®"
        
    - name: Generate update summary
      run: |
        # ç”Ÿæˆæ›´æ–°æ‘˜è¦
        if [ -f crawler_output.txt ]; then
          echo "ğŸ“Š æœ¬æ¬¡æ•°æ®æ›´æ–°ç»Ÿè®¡ï¼š" > update_summary.md
          echo "==========================" >> update_summary.md
          echo "" >> update_summary.md
          
          # æå–å„ç±»å‹æ•°æ®æ•°é‡
          echo "ğŸ“ˆ æ•°æ®åˆ†ç±»ç»Ÿè®¡ï¼š" >> update_summary.md
          grep "è·å–åˆ°" crawler_output.txt | while read line; do
            echo "- $line" >> update_summary.md
          done
          
          # æ€»æ•°æ®é‡
          if [ -n "${{ steps.run-crawler.outputs.total_count }}" ]; then
            echo "" >> update_summary.md
            echo "âœ… æ€»å…±è·å–åˆ° ${{ steps.run-crawler.outputs.total_count }} æ¡çƒ­ç‚¹æ•°æ®" >> update_summary.md
          fi
          
          # æ›´æ–°æ—¶é—´
          echo "" >> update_summary.md
          echo "ğŸ• æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> update_summary.md
          
          echo "æ›´æ–°æ‘˜è¦å·²ç”Ÿæˆ"
        fi
        
    - name: Commit and push data updates
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ·»åŠ å˜åŒ–çš„æ–‡ä»¶
        if [ "${{ steps.check-changes.outputs.json_changed }}" = "true" ]; then
          git add hotspot_data.json
        fi
        
        # æ·»åŠ æ›´æ–°æ‘˜è¦æ–‡ä»¶
        if [ -f update_summary.md ]; then
          git add update_summary.md
        fi
        
        # ç”Ÿæˆæäº¤ä¿¡æ¯
        commit_message="Auto-update data files $(date +'%Y-%m-%d %H:%M:%S')"
        if [ -n "${{ steps.run-crawler.outputs.total_count }}" ]; then
          commit_message="ğŸ“Š æ•°æ®æ›´æ–°: ${{ steps.run-crawler.outputs.total_count }}æ¡çƒ­ç‚¹æ•°æ® $(date +'%H:%M:%S')"
        fi
        
        git commit -m "$commit_message"
        
        # ä½¿ç”¨GITHUB_TOKENè¿›è¡Œæ¨é€
        git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main
        
        # æœ‰æ•°æ®æ›´æ–°æ—¶é‡ç½®è®¡æ•°å™¨
        echo "0" > no_changes_counter.txt
        echo "æ•°æ®å·²æ›´æ–°ï¼Œé‡ç½®æœªæ›´æ–°è®¡æ•°å™¨" >> update_summary.md
        
    - name: No changes notification
      if: steps.check-changes.outputs.changes == 'false'
      run: |
        echo "No database changes detected"
        
        # æ£€æŸ¥è¿ç»­æœªæ›´æ–°æ¬¡æ•°
        if [ -f no_changes_counter.txt ]; then
          current_count=$(cat no_changes_counter.txt)
          new_count=$((current_count + 1))
        else
          new_count=1
        fi
        
        echo $new_count > no_changes_counter.txt
        
        # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æé†’é˜ˆå€¼ï¼ˆ16æ¬¡ = 4å°æ—¶ï¼‰
        if [ $new_count -ge 16 ]; then
          echo "âš ï¸ è¿ç»­ $new_count æ¬¡æœªæŠ“å–åˆ°æ–°å†…å®¹ï¼è¯·æ£€æŸ¥çˆ¬è™«ç¨‹åº" >> update_summary.md
          echo "è¿ç»­ $new_count æ¬¡æœªæ›´æ–°ï¼Œå¯èƒ½éœ€è¦äººå·¥å¹²é¢„" > critical_alert.md
          
          # é‡ç½®è®¡æ•°å™¨
          echo "0" > no_changes_counter.txt
        else
          echo "è¿ç»­æœªæ›´æ–°æ¬¡æ•°: $new_count" >> update_summary.md
        fi
        
    - name: Check daily data freshness
      run: |
        # æ£€æŸ¥å½“å¤©æ˜¯å¦æœ‰æ•°æ®æ›´æ–°
        current_date=$(date +%Y-%m-%d)
        if ! grep -q "$current_date" hotspot_data.json 2>/dev/null; then
          echo "âŒ ä»Šå¤© ($current_date) æœªæŠ“å–åˆ°ä»»ä½•æ–°å†…å®¹ï¼" >> update_summary.md
          echo "å½“æ—¥æ— æ•°æ®æ›´æ–°è­¦æŠ¥" > daily_alert.md
        fi
        
    - name: Send critical alerts
      if: always()
      run: |
        # å¦‚æœæœ‰ä¸¥é‡è­¦æŠ¥ï¼Œåœ¨è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼ˆå¦‚å‘é€é‚®ä»¶ã€Slackæ¶ˆæ¯ç­‰ï¼‰
        if [ -f critical_alert.md ]; then
          echo "å‘é€ä¸¥é‡è­¦æŠ¥..."
          cat critical_alert.md
          # è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€Slackã€Discordç­‰é€šçŸ¥æ–¹å¼
        fi
        
        if [ -f daily_alert.md ]; then
          echo "å‘é€å½“æ—¥æ— æ•°æ®è­¦æŠ¥..."
          cat daily_alert.md
        fi